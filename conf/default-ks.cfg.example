%post --log=/root/my-ks-post.log

rtype=rel-eng
rtype=nightly
downhostname=download.devel.redhat.com
verx=$(rpm -E %rhel)
case $verx in
8|9)
	buildrootUrl=http://$downhostname/rhel-$verx/$rtype/BUILDROOT-$verx/latest-BUILDROOT-$verx-RHEL-$verx/compose/Buildroot/$(arch)/os/
	cat <<-EOF >/etc/yum.repos.d/beaker-buildroot.repo
	[beaker-buildroot]
	name=beaker-buildroot
	baseurl=$buildrootUrl
	enabled=1
	gpgcheck=0
	skip_if_unavailable=1
	EOF
	;;
esac

cat /usr/bin/rhts-environment.sh
cat <<-'EOF' >>/usr/bin/rhts-environment.sh
	# see: https://restraint.readthedocs.io/en/latest/remove_rhts.html#legacy-rhts-task-environment-variables
	# if restraint runs in un-compatable mode, and we still use old ENV name
	if [[ -n "$RSTRNT_JOBID" && -z "$JOBID" ]]; then
		export RHTS_COMPAT=no
		export ARCH="$RSTRNT_OSARCH" \
		DISTRO="$RSTRNT_OSDISTRO" \
		FAMILY="$RSTRNT_OSMAJOR" \
		JOBID="$RSTRNT_JOBID" \
		REBOOTCOUNT="$RSTRNT_REBOOTCOUNT" \
		RECIPESETID="$RSTRNT_RECIPESETID" \
		RECIPEID="$RSTRNT_RECIPEID" \
		RECIPETESTID="$RSTRNT_RECIPEID" \
		SUBMITTER="$RSTRNT_OWNER" \
		TASKID="$RSTRNT_TASKID" \
		TESTID="$RSTRNT_TASKID" \
		TESTNAME="$RSTRNT_TASKNAME" \
		TESTPATH="$RSTRNT_TASKPATH" \
		VARIANT="$RSTRNT_OSVARIANT"
	fi

	#if required kernel Library getting fail
	kurl=https://gitlab.cee.redhat.com/kernel-qe/kernel/-/archive/master/kernel-master.tar.bz2
	kfile=${kurl##*/}
	targetdir=/mnt/tests/kernel
	casedirs=$(sed -nr '/^.*"RhtsRequires:\s+library\(kernel\/([^"]+)\)" .*$/{s@@Library/\1@;p}' Makefile | sort -u | xargs)
	if [[ -n "$casedirs" ]]; then
		mkdir -p $targetdir
		for dir in $casedirs; do test -d $targetdir/$dir || dirs+="$dir "; done
		if [[ -n "$dirs" ]]; then
			echo "{debug} repo-requires fetch: ${kurl}"
			curl -k -Ls ${kurl} -o ${kfile}
			test -f ${kfile} && { tar -C $targetdir -jxf ${kfile} $(eval "echo ${kfile%%.*}/{${dirs[@]// /,}}") --strip-components=1; }
		fi
		for dir in $dirs; do
			test -d $targetdir/$dir || { echo "{error} require $dir fetch fail"; continue; }
			pkgs=$(sed -nr '/^.*"Requires:\s+([^"()]+)" .*$/{s//\1/;s/ +/\n/;p}' $targetdir/$dir/Makefile | sort -u | xargs)
			[[ -n "$pkgs" ]] && yum install -y $pkgs
		done
	fi
	unset kurl kfile targetdir casedirs dirs pkgs
EOF

%end
