%post --log=/root/my-ks-post.log

test -f /etc/dnf/dnf.conf && echo strict=0 >>/etc/dnf/dnf.conf

read type distro <<< $(awk -F/+ '/^baseurl/{ for (i=3;i<NF;i++) { if ($(i+1) ~ /RHEL-/) { print($i, $(i+1)); break }}}' /etc/yum.repos.d/beaker-BaseOS.repo)
if [[ "$distro" = RHEL-8* ]]; then
	URL=http://download.devel.redhat.com/$type/latest-BUILDROOT-8-RHEL-8/compose/Buildroot/$(arch)/os
	cat <<-EOF >/etc/yum.repos.d/beaker-buildroot.repo
	[beaker-buildroot]
	name=beaker-buildroot
	baseurl=$URL
	enabled=1
	gpgcheck=0
	skip_if_unavailable=1
	EOF
fi

yum install -y gcc wget screen bc redhat-lsb-core sg3_utils sg3_utils-libs sg3_utils-devel rsyslog python2

[[ -f /usr/bin/python ]] || {
	if [[ -f /usr/bin/python2 ]]; then
		ln -s /usr/bin/python2 /usr/bin/python
	elif [[ -f /usr/bin/python3 ]]; then
		ln -s /usr/bin/python3 /usr/bin/python
	fi
}

%end
